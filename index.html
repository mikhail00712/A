<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Рабочее время</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #e4e7ee;
    }
    body {
      min-height: 100vh;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      color: #24273b;
      letter-spacing: 0.01em;
    }
    header {
      width: 100vw;
      padding: 32px 0 0 0;
      text-align: center;
      font-size: 2.35em;
      font-weight: 800;
      letter-spacing: 0.03em;
      color: #fff;
      background: #6d758f;
      margin-bottom: 32px;
      border-radius: 0 0 22px 22px;
      box-shadow: 0 2px 16px #a9adc4bb;
    }
    .container {
      width: 100vw;
      max-width: 500px;
      margin: 0 auto;
      padding: 0 5vw;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .block {
      background: #fff;
      border-radius: 13px;
      box-shadow: 0 3px 15px #e6e6ef33;
      padding: 18px 18px 14px 18px;
      margin-bottom: 18px;
      width: 100%;
      max-width: 480px;
    }
    .row {
      display: flex;
      align-items: center;
      margin-bottom: 13px;
      flex-wrap: wrap;
    }
    .row label {
      min-width: 140px;
      font-size: 1em;
      color: #23262e;
      margin-right: 10px;
      margin-bottom: 4px;
    }
    .input-short,
    .input-medium {
      font-size: 1.09em;
      border-radius: 8px;
      border: 1.5px solid #bfc2d6;
      background: #f3f4f9;
      color: #24273b;
      font-weight: 600;
      padding: 6px 10px;
      text-align: center;
      margin-right: 7px;
      margin-bottom: 2px;
      box-shadow: 0 1px 3px #d2d6e8aa;
      outline: none;
      width: 60px;
    }
    .input-medium { width: 90px; }
    .input-dual {
      display: flex;
      align-items: center;
    }
    .input-dual input { width: 48px; margin-right: 3px; }
    .file-label {
      display: inline-block;
      padding: 16px 36px;
      background: #234ad8;
      color: #fff;
      border-radius: 20px;
      font-size: 1.13em;
      font-weight: 700;
      cursor: pointer;
      margin: 0 0 12px 0;
      box-shadow: 0 2px 12px #b5b8c9a0;
      border: none;
      letter-spacing: 0.01em;
    }
    .file-label:hover {
      background: #1e3ca7;
    }
    input[type="file"] { display: none; }
    #progress {
      font-size: 1.05em;
      color: #234ad8;
      margin-top: 8px;
      margin-bottom: 8px;
      text-align: center;
      font-weight: 600;
      letter-spacing: 0.01em;
    }
    .sum-block {
      margin-top: 28px;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 16px #d2e2e244;
      padding: 22px 14px 20px 14px;
      font-size: 1.2em;
      text-align: center;
      font-weight: 700;
      color: #234ad8;
      letter-spacing: 0.02em;
      width: 100%;
      max-width: 420px;
    }
    @media (max-width: 600px) {
      header { font-size: 1.3em; padding: 20px 0 0 0; }
      .container { max-width: 99vw; padding: 0 2vw; }
      .block, .sum-block { max-width: 99vw; }
      .file-label { font-size: 1em; padding: 13px 16px; }
    }
  </style>
</head>
<body>
  <header>РАБОЧЕЕ ВРЕМЯ</header>
  <div class="container">

    <!-- Загрузка скриншота и ручной ввод -->
    <div class="block">
      <div class="row">
        <label class="file-label">
          Загрузить скриншот
          <input type="file" id="imageInput" accept="image/*">
        </label>
        <span id="progress"></span>
      </div>
      <div class="row">
        <label>Ввести время вручную:</label>
        <div class="input-dual">
          <input type="number" min="0" id="manualHours" placeholder="ч." class="input-short">
          <span>ч</span>
          <input type="number" min="0" max="59" id="manualMinutes" placeholder="м." class="input-short">
          <span>мин</span>
        </div>
      </div>
    </div>

    <!-- Больничный/отпуск -->
    <div class="block">
      <div class="row">
        <label for="extraDays" style="min-width:210px;">Больничный/отпуск <br><span style="font-size:0.93em;font-weight:400;color:#697084;">(дней, не по парадной, не на выходные и праздники)</span>:</label>
        <input type="number" id="extraDays" min="0" step="1" value="0" class="input-short">
      </div>
    </div>

    <!-- Резервы, тренажер -->
    <div class="block">
      <div class="row">
        <label for="reserveHomeH">Резерв в месте жительства:</label>
        <div class="input-dual">
          <input type="number" min="0" id="reserveHomeH" placeholder="ч." class="input-short">
          <span>ч</span>
          <input type="number" min="0" max="59" id="reserveHomeM" placeholder="м." class="input-short">
          <span>мин</span>
        </div>
      </div>
      <div class="row">
        <label for="reserveHotelH">Резерв в гостинице:</label>
        <div class="input-dual">
          <input type="number" min="0" id="reserveHotelH" placeholder="ч." class="input-short">
          <span>ч</span>
          <input type="number" min="0" max="59" id="reserveHotelM" placeholder="м." class="input-short">
          <span>мин</span>
        </div>
      </div>
      <div class="row">
        <label for="trainingH">Тренажёр/предварительная/учёба на земле:</label>
        <div class="input-dual">
          <input type="number" min="0" id="trainingH" placeholder="ч." class="input-short">
          <span>ч</span>
          <input type="number" min="0" max="59" id="trainingM" placeholder="м." class="input-short">
          <span>мин</span>
        </div>
      </div>
    </div>

    <!-- Командировка -->
    <div class="block">
      <div class="row">
        <label>Командировка (закрытие смены):</label>
        <div class="input-dual">
          <input type="number" min="0" max="23" id="closeShiftH" placeholder="чч" class="input-short">
          <span>:</span>
          <input type="number" min="0" max="59" id="closeShiftM" placeholder="мм" class="input-short">
        </div>
      </div>
      <div class="row">
        <label>Открытие смены:</label>
        <div class="input-dual">
          <input type="number" min="0" max="23" id="openShiftH" placeholder="чч" class="input-short">
          <span>:</span>
          <input type="number" min="0" max="59" id="openShiftM" placeholder="мм" class="input-short">
        </div>
      </div>
    </div>

    <!-- Итоговый подсчет -->
    <div class="sum-block" id="sumBlock">
      Сумма рабочего времени: <br>
      <span id="finalSum" style="font-size:1.4em;"></span>
    </div>
  </div>

  <!-- Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    // Расчет из скриншота
    let screenshotMinutes = 0;
    let manualMinutes = 0;
    let extraMinutes = 0;
    let reserveHomeMinutes = 0;
    let reserveHotelMinutes = 0;
    let trainingMinutes = 0;
    let tripMinutes = 0;

    function toTimeString(minutes) {
      const h = Math.floor(minutes / 60);
      const m = minutes % 60;
      return h + ' ч ' + m + ' мин';
    }

    function calcTripTime() {
      let closeH = parseInt(document.getElementById('closeShiftH').value) || 0;
      let closeM = parseInt(document.getElementById('closeShiftM').value) || 0;
      let openH = parseInt(document.getElementById('openShiftH').value) || 0;
      let openM = parseInt(document.getElementById('openShiftM').value) || 0;
      let total = ((closeH * 60 + closeM) - (openH * 60 + openM));
      if (total < 0) total += 24 * 60; // если через полночь
      return Math.floor(total / 4);
    }

    function updateSum() {
      // Скриншот + ручной ввод
      let baseMinutes = screenshotMinutes + manualMinutes;
      // Больничный/отпуск
      let days = parseInt(document.getElementById('extraDays').value) || 0;
      extraMinutes = days * (7 * 60 + 12);

      // Резервы и тренажёры делим на 4
      let rh = (parseInt(document.getElementById('reserveHomeH').value) || 0) * 60;
      let rm = parseInt(document.getElementById('reserveHomeM').value) || 0;
      reserveHomeMinutes = Math.floor((rh + rm) / 4);

      let hh = (parseInt(document.getElementById('reserveHotelH').value) || 0) * 60;
      let hm = parseInt(document.getElementById('reserveHotelM').value) || 0;
      reserveHotelMinutes = Math.floor((hh + hm) / 4);

      let th = (parseInt(document.getElementById('trainingH').value) || 0) * 60;
      let tm = parseInt(document.getElementById('trainingM').value) || 0;
      trainingMinutes = Math.floor((th + tm) / 4);

      // Командировка — закрытие минус открытие / 4
      tripMinutes = calcTripTime();

      // Финал
      let sum = baseMinutes + extraMinutes + reserveHomeMinutes +
        reserveHotelMinutes + trainingMinutes + tripMinutes;

      document.getElementById('finalSum').textContent = toTimeString(sum);
    }

    // Все input'ы вызывают updateSum
    Array.from(document.querySelectorAll('input')).forEach(el =>
      el.addEventListener('input', updateSum)
    );

    // Скриншот
    document.getElementById('imageInput').addEventListener('change', async function(e) {
      const file = e.target.files[0];
      if (!file) return;
      document.getElementById('progress').textContent = 'Распознаём...';
      screenshotMinutes = 0;
      updateSum();

      const { data: { text } } = await Tesseract.recognize(
        file, 'rus',
        { logger: m => {
          if (m.status === 'recognizing text') {
            document.getElementById('progress').textContent = `Распознавание: ${Math.round(m.progress*100)}%`;
          }
        } }
      );
      document.getElementById('progress').textContent = '';
      // Суммируем часы и минуты по паттерну
      const re = /(\d+)\s*ч\s*(\d+)\s*мин/gi;
      let total = 0, match;
      while ((match = re.exec(text)) !== null) {
        let h = parseInt(match[1]);
        let m = parseInt(match[2]);
        total += h * 60 + m;
      }
      screenshotMinutes = total;
      updateSum();
    });

    // Ручной ввод времени
    function updateManual() {
      let h = parseInt(document.getElementById('manualHours').value) || 0;
      let m = parseInt(document.getElementById('manualMinutes').value) || 0;
      manualMinutes = h * 60 + m;
      updateSum();
    }
    document.getElementById('manualHours').addEventListener('input', updateManual);
    document.getElementById('manualMinutes').addEventListener('input', updateManual);

    updateSum(); // Для инициализации
  </script>
</body>
</html>
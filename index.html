// Добавляем в начало скрипта
function debounce(func, timeout = 300) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => { func.apply(this, args); }, timeout);
  };
}

// Модифицируем showPretimes
const optimizedShowPretimes = debounce(showPretimes);

// Обновляем все обработчики событий с showPretimes на optimizedShowPretimes

// Добавляем валидацию минут
function validateMinutes(input) {
  if (input.value > 59) input.value = 59;
  if (input.value < 0) input.value = 0;
}

// Обновляем рендер блоков (например, для flyBlocks)
function renderFlyBlocks() {
  let flyDiv = document.getElementById('flyBlocks');
  flyDiv.innerHTML = '';
  flyBlocks.forEach((b, i) => {
    flyDiv.innerHTML += `
      <div class="input-row" style="margin-bottom:4px;">
        <label style="min-width:105px;">Время вылета:</label>
        <input type="number" min="0" max="23" id="flyOutH${i}" placeholder="ч." class="input-short" value="${b.outH || ''}"
          oninput="validateMinutes(this); optimizedShowPretimes()">
        <input type="number" min="0" max="59" id="flyOutM${i}" placeholder="м." class="input-short" value="${b.outM || ''}"
          oninput="validateMinutes(this); optimizedShowPretimes()">
      </div>
      <div class="input-row" style="margin-bottom:2px;">
        <label style="min-width:105px;">Время прилёта:</label>
        <input type="number" min="0" max="23" id="flyInH${i}" placeholder="ч." class="input-short" value="${b.inH || ''}"
          oninput="validateMinutes(this); optimizedShowPretimes()">
        <input type="number" min="0" max="59" id="flyInM${i}" placeholder="м." class="input-short" value="${b.inM || ''}"
          oninput="validateMinutes(this); optimizedShowPretimes()">
        ${i > 0 ? `<button type="button" class="remove-btn" onclick="removeFlyBlock(${i})">−</button>` : ''}
      </div>
    `;
  });
  // ... остальной код
}

// Улучшаем обработку командировок
function calculateCmdMinutes() {
  let cmdMin = 0;
  const mb = document.getElementById('multiBase').checked;
  
  if (!mb) {
    for (let cmd of cmdBlocks) {
      if (cmd.close && cmd.open) {
        try {
          let close = new Date(cmd.close);
          let open = new Date(cmd.open);
          // Получаем разницу в днях, а не только в минутах
          let diff = (close.getTime() - open.getTime()) / (1000 * 60);
          // Убираем проверку на отрицательные значения - работаем с абсолютной разницей
          cmdMin += Math.abs(Math.round(diff));
        } catch (e) {
          console.error("Ошибка обработки даты командировки:", e);
        }
      }
    }
  }
  return cmdMin;
}

// Добавляем CSS для валидации
<style>
  .input-short.invalid {
    border-color: #e44848;
    background-color: #f5e4e6;
  }
  .delta.negative {
    color: #e44848;
    font-weight: 800;
  }
  .delta.positive {
    color: #23bb56;
    font-weight: 800;
  }
  .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>